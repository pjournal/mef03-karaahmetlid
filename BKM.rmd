---
title: "BKM Assignment"
author: "Dost Karaahmetli"
date: "November 7, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Start}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(rvest)
library(grid)
```


## Step 1 - Data Preparation for Analysis as of end of 2018
### Download and read year end data 2018 from the website
```{r}
url <- "https://bkm.com.tr/secilen-aya-ait-sektorel-gelisim/?filter_year=2018&filter_month=12&List=Listele" 
page <- read_html(url) 
year_end_2018 <- html_table(page, fill=TRUE)
year_end_2018
```

### Select the columns and processing of raw data, since I'm only interested in CC data.
```{r}
year_end_2018 <- year_end_2018[[4]] %>% slice(-(1:2)) %>% filter(X1 != "TOPLAM") %>% select(1, 2, 4)
colnames(year_end_2018) <- c("isyeri", "islem_adedi", "islem_tutari")
year_end_2018
```

### Changing Character Columns to Numeric Values
```{r}
year_end_2018$islem_adedi <- as.numeric(gsub("\\.","", year_end_2018$islem_adedi))
year_end_2018$islem_tutari <- as.numeric(gsub(",",".",gsub("\\.","", year_end_2018$islem_tutari)))
str(year_end_2018)
```

## Step 2 - Analysis as of end of 2018 
### A - Total Number of Transactions and Total CC Spendings per sector 
```{r}
adet <- ggplot(year_end_2018, aes(x=isyeri, y=islem_adedi)) +
  geom_bar(stat="identity",fill="steelblue")+ coord_flip() + scale_y_continuous(labels=comma) +
  labs(title = "Credit Card Transaction By Sector", x="", y="") +theme_minimal() 

tutar <- ggplot(year_end_2018, aes(x=isyeri, y=islem_tutari)) +
  geom_bar(stat="identity",fill="lightgreen") + coord_flip() + scale_y_continuous(labels=comma) +
  labs(title = "Credit Card Total Spending By Sector", x="", y="") +theme_minimal()
  
grid.newpage()
grid.draw(rbind(ggplotGrob(adet), ggplotGrob(tutar), size = "last"))
```

### B - Top 10 Sectors in terms of Total CC Spendings
```{r}
share <- year_end_2018 %>% group_by(isyeri) %>% summarise(islem_tutari = sum(islem_tutari)) %>% 
  mutate(harcama_payi = islem_tutari/sum(islem_tutari)) %>% top_n(10, harcama_payi)

share_plot <- ggplot(share, aes(x=isyeri, y=islem_tutari, fill=isyeri)) +
  geom_bar(stat="identity")+
  coord_polar()+
  theme(legend.position = "right", axis.text.x = element_text(angle = 0))+
  geom_text(aes(y = islem_tutari , label = islem_tutari))+
  labs(title = "Sectoral shares")

share_plot
```

### C - Average Spending per Transaction
```{r}
cart_volume <- year_end_2018 %>% group_by(isyeri) %>% mutate(avg_spending = islem_tutari/islem_adedi*1000000)
cart_volume

ggplot(cart_volume, aes(x=isyeri, y=avg_spending)) +
  geom_bar(stat="identity",fill="orange")+ coord_flip() + scale_y_continuous(labels=comma) +
  labs(title = "Amount of Spending per Transaction", x="", y="") +theme_minimal() 
```



